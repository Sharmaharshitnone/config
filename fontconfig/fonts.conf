<?xml version="1.0"?>
<!DOCTYPE fontconfig SYSTEM "urn:fontconfig:fonts.dtd">
<!--
  User fontconfig - improved, concise and safe defaults
  - Places to add user fonts: ~/.local/share/fonts and ~/.fonts
  - Rendering sensible defaults for modern Linux distributions
  - Clear aliases and emoji handling
  Keep a backup of this file before editing further.
-->
<fontconfig>

  <!-- 1) Make sure user font dirs are scanned (fontconfig typically does this, but explicit dirs are helpful) -->
  <dir>~/.local/share/fonts</dir>
  <dir>~/.fonts</dir>

  <!-- 2) Rendering defaults (safe, modern choices) -->
  <match target="font">
    <edit name="antialias" mode="assign"><bool>true</bool></edit>
    <edit name="autohint" mode="assign"><bool>false</bool></edit>
    <edit name="hinting" mode="assign"><bool>true</bool></edit>
    <edit name="hintstyle" mode="assign"><const>hintslight</const></edit>
    <edit name="rgba" mode="assign"><const>rgb</const></edit>
    <edit name="lcdfilter" mode="assign"><const>lcddefault</const></edit>
    <!-- Leave embeddedbitmap false: avoids tiny bitmap fonts being forced on modern screens -->
    <edit name="embeddedbitmap" mode="assign"><bool>false</bool></edit>
  </match>

  <!-- 2.1) Special handling for color emoji fonts to fix WebRender glyph rasterization -->
  <match target="font">
    <test name="color" compare="eq"><bool>true</bool></test>
    <edit name="antialias" mode="assign"><bool>false</bool></edit>
    <edit name="hinting" mode="assign"><bool>false</bool></edit>
    <edit name="embeddedbitmap" mode="assign"><bool>true</bool></edit>
  </match>

  <!-- 3) Clear, predictable aliases for families so apps asking for 'serif/sans/monospace' get good results -->
  <alias>
    <family>serif</family>
    <prefer>
      <family>Noto Serif</family>
      <family>Liberation Serif</family>
      <family>DejaVu Serif</family>
      <family>Noto Color Emoji</family>
    </prefer>
  </alias>

  <alias>
    <family>sans-serif</family>
    <prefer>
      <family>Noto Sans</family>
      <family>Liberation Sans</family>
      <family>DejaVu Sans</family>
      <family>Noto Color Emoji</family>
    </prefer>
  </alias>

  <!-- map shorter names to their canonical aliases -->
  <alias binding="strong"><family>sans</family><prefer><family>sans-serif</family></prefer></alias>
  <alias binding="strong"><family>mono</family><prefer><family>monospace</family></prefer></alias>

  <alias>
    <family>monospace</family>
    <prefer>
      <family>JetBrainsMono Nerd Font</family>
      <family>Noto Mono</family>
      <family>Liberation Mono</family>
      <family>DejaVu Sans Mono</family>
      <family>Noto Color Emoji</family>
    </prefer>
  </alias>

  <!-- 4) Friendly fallbacks for common proprietary font requests -->
  <match target="pattern">
    <test qual="any" name="family"><string>Arial</string></test>
    <edit name="family" mode="assign" binding="strong"><string>Noto Sans</string></edit>
  </match>
  <match target="pattern">
    <test qual="any" name="family"><string>Helvetica</string></test>
    <edit name="family" mode="assign" binding="strong"><string>Noto Sans</string></edit>
  </match>
  <match target="pattern">
    <test qual="any" name="family"><string>Times New Roman</string></test>
    <edit name="family" mode="assign" binding="strong"><string>Noto Serif</string></edit>
  </match>
  <match target="pattern">
    <test qual="any" name="family"><string>Courier New</string></test>
    <edit name="family" mode="assign" binding="strong"><string>JetBrainsMono Nerd Font</string></edit>
  </match>

  <!-- 5) Enhanced emoji handling and fallbacks -->
  <!-- Prioritize emoji when "emoji" family is requested -->
  <match target="pattern">
    <test name="family"><string>emoji</string></test>
    <edit name="family" mode="prepend" binding="strong"><string>Noto Color Emoji</string></edit>
  </match>
  
  <!-- Ensure emoji fonts are always available as fallbacks for any text -->
  <match target="pattern">
    <edit name="family" mode="append"><string>Noto Color Emoji</string></edit>
  </match>

  <!-- Handle specific emoji font requests -->
  <match target="pattern">
    <test name="family"><string>Apple Color Emoji</string></test>
    <edit name="family" mode="assign" binding="strong"><string>Noto Color Emoji</string></edit>
  </match>
  <match target="pattern">
    <test name="family"><string>Segoe UI Emoji</string></test>
    <edit name="family" mode="assign" binding="strong"><string>Noto Color Emoji</string></edit>
  </match>

  <!-- 6) Optional: a small rule to avoid accidentally matching family names with surrounding whitespace
       This is intentionally conservative: it doesn't rewrite names, but ensures normal font lookups work. -->

</fontconfig>

